#!name=Loon Final iOS Streaming + AI
#!desc=App级分流｜AI独立DNS｜Twitter媒体拆分｜五国策略｜毕业版

[General]
loglevel = notify
skip-proxy = 192.168.0.0/16,10.0.0.0/8,172.16.0.0/12,localhost
ipv6 = false
allow-wifi-access = true
udp-policy-not-supported-behaviour = REJECT
disconnect-on-policy-change = true

[DNS]
# 默认 DNS（系统友好）
server = 223.5.5.5, 119.29.29.29
fallback = 1.1.1.1, 8.8.8.8
dns-fallback-system = true

# AI 独立 DNS（极稳）
AI_DNS = 1.1.1.1, 1.0.0.1

[Policy]
# ===== 基础国家延迟组 =====
HK = latency, regex=(香港|港|HK), interval=300, timeout=5, tolerance=50
TW = latency, regex=(台湾|台|TW), interval=300, timeout=5, tolerance=50
JP = latency, regex=(日本|日|JP), interval=300, timeout=5, tolerance=50
US = latency, regex=(美国|美|US), interval=300, timeout=5, tolerance=80
SG = latency, regex=(新加坡|新|SG), interval=300, timeout=5, tolerance=50
KR = latency, regex=(韩国|韩|KR), interval=300, timeout=5, tolerance=50

# ===== 场景专用测速 =====
US_AI = latency, regex=(美国|美|US), interval=600, timeout=6, tolerance=120
US_TW_MEDIA = latency, regex=(美国|美|US), interval=180, timeout=4, tolerance=40
STREAM_AUTO = latency, regex=(美国|美|US|新加坡|新|SG|日本|日|JP), interval=300, timeout=5, tolerance=80

# ===== 策略组 =====
AI_US     = select, US_AI, MANUAL
TW_MEDIA  = select, US_TW_MEDIA, MANUAL
TIKTOK    = select, JP, MANUAL
META      = select, KR, MANUAL
STREAMING = select, STREAM_AUTO, US, SG, JP, MANUAL
YOUTUBE   = select, HK, JP, US, MANUAL
APPLE     = select, DIRECT, HK, JP, MANUAL
CHINA     = select, DIRECT, HK
GLOBAL    = select, US, SG, JP, MANUAL
MANUAL    = select, regex=.*

[Rule]
# ================= App 级分流（最高优先级） =================

# ---- AI（美国 + 独立 DNS）----
PROCESS-NAME,ChatGPT,AI_US,AI_DNS
PROCESS-NAME,chatgpt,AI_US,AI_DNS
PROCESS-NAME,Google,AI_US,AI_DNS
PROCESS-NAME,Gemini,AI_US,AI_DNS
PROCESS-NAME,Grok,AI_US,AI_DNS

# ---- Twitter ----
PROCESS-NAME,Twitter,AI_US
PROCESS-NAME,X,AI_US
PROCESS-NAME,Twitter,TW_MEDIA
PROCESS-NAME,X,TW_MEDIA

# ---- TikTok 日本 ----
PROCESS-NAME,TikTok,TIKTOK

# ---- Meta 韩国 ----
PROCESS-NAME,Instagram,META
PROCESS-NAME,Facebook,META
PROCESS-NAME,WhatsApp,META

# ---- Streaming ----
PROCESS-NAME,Netflix,STREAMING
PROCESS-NAME,Disney+,STREAMING
PROCESS-NAME,Spotify,STREAMING
PROCESS-NAME,YouTube,YOUTUBE

# ================= 域名兜底 =================

# AI / Google
DOMAIN-SUFFIX,openai.com,AI_US,AI_DNS
DOMAIN-SUFFIX,chatgpt.com,AI_US,AI_DNS
DOMAIN-SUFFIX,oaistatic.com,AI_US,AI_DNS
DOMAIN-SUFFIX,oaiusercontent.com,AI_US,AI_DNS
DOMAIN-SUFFIX,google.com,AI_US,AI_DNS
DOMAIN-SUFFIX,googleapis.com,AI_US,AI_DNS
DOMAIN-SUFFIX,gstatic.com,AI_US,AI_DNS
DOMAIN-SUFFIX,googleusercontent.com,AI_US,AI_DNS

# Twitter Media
DOMAIN-SUFFIX,twimg.com,TW_MEDIA

# TikTok
DOMAIN-SUFFIX,tiktok.com,TIKTOK
DOMAIN-SUFFIX,tiktokcdn.com,TIKTOK
DOMAIN-SUFFIX,tiktokv.com,TIKTOK

# Meta
DOMAIN-SUFFIX,facebook.com,META
DOMAIN-SUFFIX,instagram.com,META
DOMAIN-SUFFIX,whatsapp.com,META

# Apple
DOMAIN-SUFFIX,apple.com,APPLE
DOMAIN-SUFFIX,icloud.com,APPLE

# 国内
GEOIP,CN,CHINA

# 兜底
FINAL,GLOBAL
